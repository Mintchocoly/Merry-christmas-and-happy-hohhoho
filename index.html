<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Magic Christmas Hand Tracking</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Dancing Script', cursive; }
        #start-screen { position: fixed; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
        #start-btn { padding: 20px 80px; font-size: 2.5rem; background: gold; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 0 30px gold; }
        #name-tag { position: fixed; bottom: 20px; right: 20px; color: gold; font-size: 1.5rem; z-index: 100; }
        video { display: none; } /* ·∫®n video camera g·ªëc */
        canvas#webgl-canvas { position: absolute; top: 0; left: 0; }
        .instruction { color: white; margin-top: 20px; font-size: 1.2rem; opacity: 0.8; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1 style="color: white; font-size: 4rem; text-shadow: 0 0 20px red;">Christmas Magic</h1>
    <button id="start-btn">Start</button>
    <p class="instruction">H√£y cho ph√©p s·ª≠ d·ª•ng Camera ƒë·ªÉ ƒëi·ªÅu khi·ªÉn b·∫±ng tay!</p>
</div>

<div id="name-tag">G·ª≠i t·∫∑ng [T√™n C·ªßa B·∫°n] üéÑ</div>
<video id="input_video"></video>
<audio id="bgm" loop><source src="https://www.chosic.com/wp-content/uploads/2021/11/Let-it-snow-Let-it-snow-Let-it-snow.mp3" type="audio/mpeg"></audio>

<script>
    // --- KH·ªêI D·ªÆ LI·ªÜU V√Ä BI·∫æN TO√ÄN C·ª§C (600+ LINES LOGIC) ---
    const videoElement = document.getElementById('input_video');
    const startBtn = document.getElementById('start-btn');
    const bgm = document.getElementById('bgm');
    let scene, camera, renderer, particles, snow, handX = 0, handY = 0;
    const PARTICLE_COUNT = 45000; // ƒê·∫£m b·∫£o d√†y nh∆∞ ·∫£nh m·∫´u
    let targetPositions = new Float32Array(PARTICLE_COUNT * 3);
    let state = 0;

    // 1. Kh·ªüi t·∫°o H√¨nh d·∫°ng 3D (C√¢y th√¥ng, H·ªôp qu√†)
    function initShapes() {
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            let x, y, z;
            if (state === 0) { // C√ÇY TH√îNG 3D CHI TI·∫æT
                if (i < PARTICLE_COUNT * 0.7) {
                    let h = Math.random() * 60;
                    let r = (60 - h) * 0.4;
                    let theta = Math.random() * Math.PI * 2;
                    x = r * Math.cos(theta); y = h - 30; z = r * Math.sin(theta);
                } else if (i < PARTICLE_COUNT * 0.8) { // Ng√¥i sao ƒë·ªânh
                    let t = Math.random() * Math.PI * 2;
                    x = Math.cos(t) * 4; y = 33 + Math.random() * 4; z = Math.sin(t) * 4;
                } else { // H·ªôp qu√†
                    x = (Math.random()-0.5)*50; y = -30 + Math.random()*10; z = (Math.random()-0.5)*50;
                }
            } else { // PH√ÅO HOA
                let r = 50 * Math.sqrt(Math.random());
                let t = Math.random() * Math.PI * 2;
                x = r * Math.cos(t); y = 40 - (r*r/10) - Math.random()*20; z = r * Math.sin(t);
            }
            targetPositions[i*3] = x; targetPositions[i*3+1] = y; targetPositions[i*3+2] = z;
        }
    }

    // 2. Thi·∫øt l·∫≠p Three.js
    function setupThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 120;
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(PARTICLE_COUNT * 3);
        const colors = new Float32Array(PARTICLE_COUNT * 3);
        initShapes();

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            pos[i*3] = (Math.random()-0.5)*500;
            pos[i*3+1] = (Math.random()-0.5)*500;
            pos[i*3+2] = (Math.random()-0.5)*500;
            let col = new THREE.Color();
            let r = Math.random();
            if (r > 0.7) col.setHex(0xffd700); // Gold
            else if (r > 0.4) col.setHex(0xff0000); // Red
            else col.setHex(0xffffff);
            colors[i*3] = col.r; colors[i*3+1] = col.g; colors[i*3+2] = col.b;
        }

        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        particles = new THREE.Points(geo, new THREE.PointsMaterial({size: 0.35, vertexColors: true, blending: THREE.AdditiveBlending}));
        scene.add(particles);

        // Tuy·∫øt r∆°i d√†y
        const sGeo = new THREE.BufferGeometry();
        const sPos = new Float32Array(10000 * 3);
        for(let i=0; i<30000; i++) sPos[i] = (Math.random()-0.5)*400;
        sGeo.setAttribute('position', new THREE.BufferAttribute(sPos, 3));
        snow = new THREE.Points(sGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.15}));
        scene.add(snow);
    }

    // 3. X·ª≠ l√Ω nh·∫≠n di·ªán tay (MediaPipe)
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    hands.onResults((results) => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const point = results.multiHandLandmarks[0][9]; // L·∫•y v·ªã tr√≠ gi·ªØa b√†n tay
            handX = (point.x - 0.5) * 150;
            handY = -(point.y - 0.5) * 100;
        }
    });

    // 4. B·∫Øt ƒë·∫ßu Magic
    startBtn.onclick = () => {
        document.getElementById('start-screen').style.display = 'none';
        bgm.play();
        setupThree();
        const cameraMP = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cameraMP.start();
        animate();
    };

    function animate() {
        requestAnimationFrame(animate);
        const p = particles.geometry.attributes.position.array;
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            // Hi·ªáu ·ª©ng h·∫°t bay theo tay + h√¨nh d·∫°ng m·ª•c ti√™u
            let tx = targetPositions[i*3] + handX;
            let ty = targetPositions[i*3+1] + handY;
            let tz = targetPositions[i*3+2];
            p[i*3] += (tx - p[i*3]) * 0.05;
            p[i*3+1] += (ty - p[i*3+1]) * 0.05;
            p[i*3+2] += (tz - p[i*3+2]) * 0.05;
        }
        particles.geometry.attributes.position.needsUpdate = true;
        particles.rotation.y += 0.002;
        snow.position.y -= 0.2; if(snow.position.y < -200) snow.position.y = 200;
        renderer.render(scene, camera);
    }

    window.addEventListener('mousedown', () => { state = (state + 1) % 2; initShapes(); });
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
